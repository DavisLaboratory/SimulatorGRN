---
title: "shinyActivationFunctionWithD"
author: "Dharmesh Bhuva"
date: "29 August 2017"
output: html_document
runtime: shiny
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE, include=FALSE}
source('../GraphGRN-methods.R')
source('../GraphGRN.R')
source('../SimulationGRN-methods.R')
source('../SimulationGRN.R')
source('analysis_methods.R')
library(igraph)
library(ggplot2)
library(plotly)
library(grid)
library(ggraph)
library(deSolve)
library(foreach)
library(nleqslv)
library(mclust)
library(shiny)

#activation function
fAct <- function(TF, EC50 = 0.5, n = 1.39) {
  B = (EC50 ^ n - 1) / (2 * EC50 ^ n - 1)
  K_n = (B - 1)
  act = B * TF ^ n / (K_n + TF ^ n)
  
  return(act)
}

#multiplot function
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

nsize = 40
```

#Conditional dependence
```{r, echo=FALSE}
plotds <- function(d, ptitle, rteqn, histoplot,dinhib){
  plotd = as.data.frame(t(d))
  cors = cor(plotd)
  cors = round(cors, digits = 2)
  #score calculation
  classf = Mclust(d['B',], verbose = F)$classification
  #calc cors
  corlowB = round(cor(plotd[classf == 1, 1:2])[1, 2], digits = 2)
  corhighB = round(cor(plotd[classf == 2, 1:2])[1, 2], digits = 2)
  classf[classf == 1] = paste('low B (', corlowB, ')', sep = '')
  classf[classf == 2] = paste('high B (', corhighB, ')', sep = '')
  plotd$BClass = classf
  
  p1 = ggplot(plotd, aes(A, C, colour = B)) + geom_point() +
    scale_colour_distiller(palette = 'RdPu', direction = 1) +
    ggtitle(paste(ptitle, ' (cor = ', cors['A', 'C'], ')', sep = '')) +
    facet_wrap(~BClass) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour="black"),
      strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0")
    )
  
  #activation function plots
  f = function(A, B, rateeqn) {
    D = 0
    if (dinhib) D = 1
    C = 0
    eval(parse(text = rateeqn))
  }
  
  #plot activation functions
  plotd = as.data.frame(t(d))
  pdata = expand.grid('A' = seq(0, 1, length.out = 100), 'B' = seq(0, 1, length.out = 100))
  pdata['Activation'] = f(pdata$A, pdata$B, rteqn)
  plotd$Activation = 1
  
  p2 = ggplot(pdata, aes(A, B, fill = Activation)) +
    geom_raster() +
    scale_fill_distiller(palette = 'YlOrRd', direction = 1) +
    ggtitle('1 act 1 inhib dependent') +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = 'none'
    ) +
    geom_point(data = plotd, aes(A, B), colour = 'white', alpha = 0.2, size = 2)
  
  lyt = matrix(c(1,1,1,2,2,1,1,1,2,2,3,3,3,3,3), byrow = T,ncol = 5)
  multiplot(p1, p2, histoplot, layout = lyt)
}

simseed = 360
nsamp = 100
```

Input models setting with A, B, C and D
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#input panel
inputPanel(
  sliderInput('b1mean', label = 'Mean of mixture 1 of B:',
              min = 0.2, max = 0.8, step = 0.1, value = 0.2),
  sliderInput('b2mean', label = 'Mean of mixture 2 of B:',
              min = 0.2, max = 0.8, step = 0.1, value = 0.6),
  sliderInput('bvar', label = 'Variance of B:',
              min = 0.025, max = 0.3, step = 0.025, value = 0.05),
  sliderInput('amean', label = 'Mean of A:',
              min = 0.2, max = 0.8, step = 0.1, value = 0.5),
  sliderInput('avar', label = 'Variance of A:',
              min = 0.025, max = 0.3, step = 0.025, value = 0.1),
  sliderInput('dmean', label = 'Mean of D:',
              min = 0.2, max = 0.8, step = 0.1, value = 0.2),
  sliderInput('dvar', label = 'Variance of D:',
              min = 0.025, max = 0.3, step = 0.025, value = 0.05),
  selectInput('type', label = 'Interaction type:',
              choices = c('D OR (A OR B)', 'D OR (A AND B) - Conditional', '!D AND (!A AND !B)', 'D OR (A AND !B) - Conditional'), selected = 'D OR (A OR B)')
)

g = new('GraphGRN')
for (n in c('B', 'A' ,'C', 'D')) {
  g = addNode(g, n)
}
g = addEdge(g, 'B', 'C', activation = T)
g = addEdge(g, 'A', 'C', activation = T)
g = addEdge(g, 'D', 'C', activation = T)

sim = new('SimulationGRN', graph = g, seed = simseed)
inputModels = sim$inputModels

renderPlot({
  #model modification
  inputModels$B$mean = c(as.numeric(input$b1mean), as.numeric(input$b2mean))
  inputModels$A$mean = as.numeric(input$amean)
  inputModels$A$sd = as.numeric(input$avar)
  inputModels$D = inputModels$A
  inputModels$D$mean = as.numeric(input$dmean)
  inputModels$D$sd = as.numeric(input$dvar)
  inputModels$B$sd = rep(as.numeric((input$bvar)), 2)
  sim$inputModels = inputModels
  
  #plot densities of inputs
  set.seed(simseed)
  # extinputs = matrix(runif(nsamp * 2), ncol = 2)
  # colnames(extinputs) = c('A', 'B')
  extinputs = NULL
  d = simulateDataset(sim, nsamp, extinputs)
  
  plotd = as.data.frame(t(d))
  cors = cor(plotd)
  cors = round(cors, digits = 2)
  
  histd = data.frame('Expr' = c(plotd$A, plotd$B, plotd$D), 'Gene' = rep(c('A', 'B', 'D'), each = nrow(plotd)))
  hplot = ggplot(histd, aes(Expr, fill = Gene)) + geom_histogram(alpha = 0.7, position = 'identity') +
    ggtitle(paste('Input data', ' (cor = ', cors['A', 'B'], ')', sep = '')) +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
  hplot
  
  if(input$type %in%  'D OR (A OR B)'){
    #2 activators OR
    g = new('GraphGRN')
    for (n in LETTERS[1:4]) {
      g = addNode(g, n)
    }
    g = addEdge(g, 'D', 'C', activation = T)
    g = addEdge(g, 'A', 'C', activation = T)
    g = addEdge(g, 'B', 'C', activation = T)
    sim = new('SimulationGRN', graph = g, seed = simseed)
    sim$inputModels = inputModels
    d = simulateDataset(sim, nsamp)
    plotds(d, 'A OR B', generateRateEqn(getNode(g, 'C'), g), hplot, F)
  }

  if(input$type %in%  'D OR (A AND B) - Conditional'){
    #2 activators AND
    g = new('GraphGRN')
    for (n in LETTERS[1:4]) {
      g = addNode(g, n)
    }
    g = addEdge(g, 'D', 'C', activation = T)
    g = addEdge(g, c('A', 'B'), 'C', activation = c(T, T), edgetype = 'and')
    sim = new('SimulationGRN', graph = g, seed = simseed)
    sim$inputModels = inputModels
    d = simulateDataset(sim, nsamp)
    plotds(d, 'A AND B', generateRateEqn(getNode(g, 'C'), g), hplot, F)
  }

  if(input$type %in%  '!D AND (!A AND !B)'){
    #2 repressors AND
    g = new('GraphGRN')
    for (n in LETTERS[1:4]) {
      g = addNode(g, n)
    }
    g = addEdge(g, c('A', 'B', 'D'), 'C', activation = c(F, F, F), edgetype = 'and')
    sim = new('SimulationGRN', graph = g, seed = simseed)
    sim$inputModels = inputModels
    d = simulateDataset(sim, nsamp)
    plotds(d, '!A AND !B', generateRateEqn(getNode(g, 'C'), g), hplot, F)
  }

  if(input$type %in%  'D OR (A AND !B) - Conditional'){
    #1 repressor, 1 Activator AND
    g = new('GraphGRN')
    for (n in LETTERS[1:4]) {
      g = addNode(g, n)
    }
    g = addEdge(g, 'D', 'C', activation = T)
    g = addEdge(g, c('A', 'B'), 'C', activation = c(T, F), edgetype = 'and')
    sim = new('SimulationGRN', graph = g, seed = simseed)
    sim$inputModels = inputModels
    d = simulateDataset(sim, nsamp)
    plotds(d, 'A AND !B', generateRateEqn(getNode(g, 'C'), g), hplot, F)
  }
})
```



